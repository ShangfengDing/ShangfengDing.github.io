---
layout: wiki
title: 实时决策引擎
categories: 流计算，决策引擎
description: 针对海量规则的高效实时决策引擎
keywords: Flink, Drools, Kafka, RETE算法
---

# 实时决策引擎

近年来，随着网络技术的高速发展和数据量的爆发增长，对数据的实时规则判定、处理和决策变成了许多实时业务的基本需求。实时营销、实时推荐和实时风控等系统成为了许多互联网和金融企业的业务需求。由于业务不断发展，规则的复杂化和数量不断攀升，加之数据量的增长，基于人工或传统的数据分析处理引擎不能很好的满足业务实时性和业务变化导致的灵活更改规则的需要，一个可以灵活可配海量规则并给出实时反馈的决策引擎成为企业的重要需求。

在面向实时性业务时，需要将实时数据分类并分发到针对此数据构建的规则网进行匹配计算给出及时的决策反馈，在此流程中分发的策略，规则网的构建和划分，触发结果的消费方式，均会影响决策引擎的执行效率。搭建能够高效处理海量规则并实时决策的决策引擎已成为增强企业竞争力的必然选择。

针对这种情况，我的研究生毕业设计课题，旨在设计并实现一个处理流式数据并支持海量规则的决策引擎。该决策引擎可以对实时的流式数据进行计算和规则匹配，并且支持多种形式的决策动作，如风控告警，实时推荐等。并且在规则方面支持海量规则的接入，支持对规则网络的划分和聚合，并且规则可配置可修改，以满足对业务变化的支持。在数据方面，提供统一的数据格式接入方式，并通过流式框架对不同吞吐量的数据进行资源的分配和调度，使流式数据可以在分布式系统上合理的分发与高效的处理。在决策执行方式上提供多样化接口，为风险控制提供告警接口，为实时推荐提供推荐内容的输出与落盘。

在技术路线选择的时候。首先选择了近年来非常火爆的流式处理框架Flink。关于规则匹配算法选择了最通用性能最好的RETE算法，并用apache开源RETE算法实现工程Drools作为项目支持。数据来源接入使用Kafka。


## 总体架构

![架构图](/images/peojects/DecisionEngine/frame1.jpg)
第一阶段

在代码开始的第一阶段，主要为了验证技术路线的可行性，确认Flink连接Kafka，并在Flink内部集成drools的可行性，没有做任何的性能指标考量，只为了能快速产出一个可运行可展示的系统。或者说此阶段为技术路线验证阶段。架构如上，Flink读取Kafka的指定topic，获得流数据，为了满足规则的可编辑性，将规则放入MySQL数据库中，每条数据来的时候，查询数据库获得所有规则。使用Drools将读取的所有规则构建RETE规则网，数据在规则网内进行匹配，如果触发，执行数据库中定义的决策语句，决策动作完成之后，接收下一条数据。

![架构图](/images/peojects/DecisionEngine/frame2.jpg)
第二阶段

在第一阶段验证成功之后，开始思考此决策引擎需要满足的特性，首先是需要支持海量规则，在技术论证阶段将所有规则读入的方式必然是不合理的，因为并不是这个topic会用到所有的规则，因此在第二阶段我引入了rule set的概念，将topic和rule set进行对应（有可能是多对一的关系），将原来的所有规则划分成了多个rule set，在数据到达时，只需去数据库中加载和此topic相关的rule set并构建规则子网即可。使决策引擎对海量规则提供了一定的持支。总结：flink和kafka满足了实时的特性，avro满足了数据格式的统一性接入，drools满足RETE规则网匹配算法，数据库和rule set提供对海量规则和可编辑性的支持。

![架构图](/images/peojects/DecisionEngine/frame3.jpg)
第三阶段

在第二阶段满足了决策引擎的基本特性之后，开始逐步考虑决策引擎的优化问题。首先我第一个想到的是与数据库的交互问题，在原架构中，每一条数据都需要和db进行一次接连交互，在数据量吞吐量很大的时候，mysql的连接数将变得不可控，对数据库的压力较大，并且影响决策引擎的效率。考虑到业务规则更改的频率并不一定很高，每次去数据库取规则获得最新规则并不是必须的，因此，将规则内容获取模块抽离，此模块将定时获得最新规则，并将新的规则写入内存，这样当数据来的时候，只需使用内存中的规则即可。规则的刷新时间可根据业务需求进行动态配置。在我的项目中，我设置为1分钟读取一次新的数据并写入内存。

![架构图](/images/peojects/DecisionEngine/frame4.jpg)
第四阶段

在解决了数据库的

![架构图](/images/peojects/DecisionEngine/frame5.jpg)
第五阶段

![架构图](/images/peojects/DecisionEngine/frame6.jpg)
第六阶段

![架构图](/images/peojects/DecisionEngine/frame7.jpg)
第七阶段



最后附上github地址
[GitHub](https://github.com/ShangfengDing/IaaS)


   
